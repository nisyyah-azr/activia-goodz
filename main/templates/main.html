<!--menggunakan base.html sebagai template utama.-->
{% extends 'base.html' %} 
{% load static %}

{% block meta %}
<title>Activia Goodz</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
<div class="bg-gray-50 w-full pt-16 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header Section -->
    <div class="mb-8">
      <p class="text-3xl font-bold text-gray-600 mb-2">The easiest way to get the best Goodz for you</p>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-4 mb-8">
      <button onclick="showModal()" class="inline-flex items-center px-4 py-2 bg-gray-800 text-white font-semibold rounded-md hover:bg-gray-700 transition-colors">
        Create Product by AJAX
      </button>
      <button onclick="refreshProducts()" class="inline-flex items-center px-4 py-2 bg-white text-gray-800 font-semibold outline outline-2 outline-gray-800 rounded-md hover:bg-gray-800 hover:text-white transition-colors">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        Refresh
      </button>
    </div>

    <!-- Filter Section -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-white rounded-lg border border-gray-200 p-4">
      <div class="flex space-x-3 mb-4 sm:mb-0">
        <button id="filter-all" onclick="changeFilter('all')" class="px-4 py-2 rounded-md font-medium transition-colors bg-gray-800 text-white">
          All
        </button>
        <button id="filter-my" onclick="changeFilter('my_products')" class="px-4 py-2 rounded-md font-medium transition-colors bg-white text-gray-700 border border-gray-300">
          My Product
        </button>
      </div>
      {% if user.is_authenticated %}
        <div class="text-sm text-gray-500">
          Last login: {{ last_login }}
        </div>
      {% endif %}
    </div>

    <!-- Loading State -->
    <div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
      <svg class="animate-spin h-8 w-8 text-cyan-600 inline-block" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-gray-600 mt-3">Loading products...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
      <div class="text-red-500 text-5xl mb-4">⚠️</div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">Failed to load products</h3>
      <p class="text-gray-500 mb-6">Please try again later.</p>
      <button onclick="refreshProducts()" class="px-4 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700">
        Retry
      </button>
    </div>

    <!-- Empty State -->
    <div id="empty" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
      <div class="w-32 h-32 mx-auto mb-4">
        <img src="{% static 'image/no-product(1).png' %}" alt="No product available" class="w-full h-full object-contain">
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
      <p class="text-gray-500 mb-6">Be the first to share a product with the community.</p>
      <button onclick="showModal()" class="px-4 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700">
        Create Product
      </button>
    </div>

    <!-- Product Grid -->
    <div id="grid" class="hidden"></div>
  </div>
</div>

{% include 'modal.html' %}

<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>

<script>
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";
let currentFilter = 'all';
let currentCategory = '';
let isLoading = false; // Flag untuk mencegah multiple requests

function showState(state) {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('error').classList.add('hidden');
    document.getElementById('empty').classList.add('hidden');
    document.getElementById('grid').classList.add('hidden');
    
    if (state === 'loading') {
        document.getElementById('loading').classList.remove('hidden');
    } else if (state === 'error') {
        document.getElementById('error').classList.remove('hidden');
    } else if (state === 'empty') {
        document.getElementById('empty').classList.remove('hidden');
    } else if (state === 'grid') {
        document.getElementById('grid').classList.remove('hidden');
        document.getElementById('grid').className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
    }
}

function getCategoryLabel(categoryCode) {
    const mapping = {
        women: 'Women',
        men: 'Men',
        kids: 'Kids',
        equipment: 'Equipment'
    };
    return mapping[categoryCode] || categoryCode;
}

function buildProductCard(item) {
    const article = document.createElement('article');
    article.className = 'group relative flex flex-col overflow-hidden border border-gray-200 bg-white transition-all duration-300 hover:shadow-xl hover:-translate-y-1';
    
    const title = DOMPurify.sanitize(item.name);
    const description = DOMPurify.sanitize(item.description);
    const price = DOMPurify.sanitize(item.price);
    const thumbnail = item.thumbnail || '';
    const category = getCategoryLabel(item.category);
    const createdAt = new Date(item.created_at).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
    
    const thumbnailHtml = thumbnail 
        ? `<img src="${thumbnail}" alt="${title}" class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105" />`
        : `<div class="h-full w-full bg-gray-100 flex items-center justify-center">
             <svg class="w-10 h-10 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
             </svg>
           </div>`;
    
    const featuredBadge = item.is_featured 
        ? `<span class="inline-flex items-center gap-x-1.5 bg-blue-100/80 px-2 py-1 text-xs font-medium text-blue-700 backdrop-blur-sm">
             <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10.868 2.884c.321-.772 1.305-.772 1.626 0l1.823 4.416 4.862.707c.85.124 1.188 1.166.574 1.765l-3.518 3.428.83 4.843c.145.845-.743 1.492-1.503 1.09L10 16.59l-4.347 2.284c-.76.402-1.648-.245-1.503-1.09l.83-4.843L1.462 9.772c-.614-.6-.276-1.641.574-1.765l4.863-.707L8.72 2.884z" clip-rule="evenodd" /></svg>
             Featured
           </span>`
        : '';
    
    const hotBadge = item.product_views > 20
        ? `<span class="inline-flex items-center gap-x-1.5 bg-red-100/80 px-2 py-1 text-xs font-medium text-red-700 backdrop-blur-sm">
             <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.238 3.855c.388-1.013-.834-1.855-1.588-1.123-.332.324-.593.738-.76 1.196C8.718 2.728 7.5 3.57 7.11 4.883 6.362 5.615 6 6.742 6 7.917c0 2.923 2.531 4.542 4.029 5.816.582.496 1.144.983 1.688 1.454.321.278.63.551.928.815.298.264.58.514.849.75.27.236.52.45.748.642.228.192.437.36.621.503.185.143.344.26.472.348.128.088.223.145.28.167.058.022.079.027.059.009-.02-.018-.09-.076-.207-.173-.117-.097-.276-.23-.473-.393-.197-.163-.427-.353-.68-.564-.253-.21-.52-.44-.793-.682-.273-.242-.544-.49-.807-.738-.263-.248-.512-.49-.745-.722-.233-.232-.448-.454-.643-.66-.195-.206-.367-.393-.513-.556-.146-.163-.261-.3-.34-.403-.078-.103-.118-.16-.118-.16s-.027.027-.083.083c-.055.056-.147.15-.272.28-.125.13-.283.296-.468.49-.185.194-.395.42-.622.667-.227.247-.467.504-.71.76-.243.256-.48.503-.702.73-.222.227-.42.428-.588.595-.168.167-.303.298-.403.39-.1.092-.16.147-.18.165-.02.018-.01.012.01.03.02.018.08.076.202.176.122.101.28.232.472.398.192.166.417.355.668.568.25.213.514.444.78.69.266.246.524.498.767.742.243.244.47.48.675.698.205.218.385.41.536.567.15.157.266.27.34.336.074.066.11.092.104.084-.006-.006-.057-.05-.145-.13-.088-.08-.21-.197-.36-.345-.15-.148-.324-.325-.518-.523-.194-.198-.398-.415-.606-.645-.208-.23-.414-.467-.608-.7-.194-.233-.37-.46-.525-.675-.155-.215-.282-.41-.38-.575-.098-.165-.165-.3-.195-.39-.03-.09-.024-.135.014-.235.038-.1.11-.213.21-.335.1-.122.225-.25.37-.382.145-.132.302-.26.468-.382.166-.122.338-.233.508-.33.17-.097.33-.178.472-.24.143-.062.26-.098.336-.106.076-.008.113.004.135.03.022.026.03.064.022.108-.008.044-.03.095-.068.154-.038.059-.09.125-.154.196-.064.07-.138.145-.22.22-.164.15-.35.31-.55.47-.2.16-.407.318-.61.465-.203.147-.39.276-.554.382-.164.106-.295.183-.383.226-.088.043-.13.054-.121.032.008-.022.083-.09.223-.226.14-.136.315-.304.518-.5.203-.196.427-.41.665-.634.238-.224.48-.45.713-.667.233-.217.45-.42.645-.598.195-.178.364-.328.502-.444.138-.116.24-.19.294-.214.054-.024.06-.018-.01-.046-.07-.028-.19-.086-.354-.173-.164-.087-.367-.197-.597-.325-.23-.128-.48-.27-.734-.42-.254-.15-.504-.304-.737-.457-.233-.153-.44-.294-.61-.418-.17-.124-.298-.225-.378-.297-.08-.072-.114-.11-.114-.11s.055-.068.15-.18.225-.26.33-.425c.104-.165.233-.355.38-.56.147-.205.308-.42.475-.635.167-.215.333-.426.49-.623.158-.197.3-.377.42-.534.12-.157.214-.282.274-.368.06-.086.08-.12.05-.136-.03-.016-.092.01-.184.074-.092.064-.21.16-.35.28-.14.12-.3.264-.477.425-.177.161-.368.335-.565.515-.197.18-.395.36-.584.53-.189.17-.365.326-.52.46-.155.134-.28.237-.363.303-.083.066-.12.09-.104.068.016-.022.08-.088.184-.19.104-.102.24-.235.402-.39.162-.155.345-.33.54-.51.195-.18.396-.363.593-.538.197-.175.383-.338.55-.48.167-.142.31-.253.418-.325.108-.072.176-.1.192-.084.016.016-.012.05-.084.12-.072.07-.18.17-.32.295-.14.125-.305.27-.49.428-.185.158-.385.328-.59.5-.205.172-.41.34-.604.5-.194.16-.368.307-.518.435-.15.128-.27.228-.352.29-.082.062-.12.084-.102.06.018-.024.085-.098.196-.215.11-.117.255-.265.42-.435.165-.17.348-.35.538-.53.19-.18.38-.36.56-.528.18-.168.344-.318.487-.444.143-.126.257-.22.33-.274.073-.054.098-.06.062-.034a.76.76 0 0 1-.41.165c-.147.03-.284.04-.41.03a.52.52 0 0 1-.31-.075c-.104-.05-.173-.09-.202-.114-.03-.024-.02-.024.028-.062.048-.038.14-.11.27-.21.13-.1.29-.22.47-.354.18-.134.37-.27.56-.4s.37-.25.53-.358c.16-.108.3-.19.41-.242.11-.052.18-.072.2-.054.02.018-.02.06-.11.15-.09.09-.22.21-.38.35s-.34.29-.52.45c-.18.16-.36.32-.52.46-.16.14-.3.26-.41.35-.11.09-.18.14-.21.15-.03.01-.01.004.04-.032.05-.036.14-.1.26-.18.12-.08.26-.17.42-.26.16-.09.32-.17.48-.24.16-.07.3-.11.41-.12.11-.01.18.01.2.06.02.05-.02.13-.1.24-.08.11-.2.25-.34.4s-.3.32-.46.47c-.16.15-.32.3-.46.43-.14.13-.26.23-.34.3-.08.07-.11.09-.08.06Z" clip-rule="evenodd" /></svg>
             Hot
           </span>`
        : '';
    
    const editDeleteButtons = CURRENT_USER_ID && Number(CURRENT_USER_ID) === Number(item.user_id)
        ? `<div class="flex items-center space-x-4">
             <button onclick="editProduct('${item.id}')" class="font-medium text-gray-600 transition-colors hover:text-blue-600">Edit</button>
             <button onclick="showDeleteModal('${item.id}')" class="font-medium text-gray-600 transition-colors hover:text-red-600">Delete</button>
           </div>`
        : '';
    
    const cardHtml = `
        <div class="aspect-video relative overflow-hidden">
            ${thumbnailHtml}
            <div class="absolute top-3 left-3">
                <span class="inline-block bg-cyan-600/90 px-3 py-1 text-xs font-semibold text-white backdrop-blur-sm">${category}</span>
            </div>
            <div class="absolute top-3 right-3 flex flex-col items-end gap-2">
                ${featuredBadge}
                ${hotBadge}
            </div>
        </div>
        <div class="flex flex-1 flex-col p-4 md:p-5">
            <div class="mb-2 flex items-center text-xs text-gray-500">
                <time>${createdAt}</time>
                <span class="mx-2">•</span>
                <span>${item.product_views} views</span>
            </div>
            <h3 class="text-lg font-bold leading-tight text-gray-800">
                <a href="/product/${item.id}/" class="transition-colors hover:text-cyan-600">
                    <span class="absolute inset-0" aria-hidden="true"></span>
                    ${title}
                </a>
                <p class="mt-1 text-base font-semibold text-green-900">Rp.${price}</p>
            </h3>
            <p class="mt-2 text-sm text-gray-600 line-clamp-3">${description}</p>
            <div class="mt-auto pt-4">
                <div class="relative z-10 flex items-center ${editDeleteButtons ? 'justify-between' : ''} text-sm">
                    <a href="/product/${item.id}/" class="font-semibold text-cyan-600 transition-colors hover:text-cyan-700"></a>
                    ${editDeleteButtons}
                </div>
            </div>
        </div>
    `;
    
    article.innerHTML = cardHtml;
    return article;
}

function renderProducts(products) {
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    products.forEach(product => {
        grid.appendChild(buildProductCard(product));
    });
}

async function fetchProducts() {
    // Prevent multiple simultaneous requests
    if (isLoading) return;
    
    try {
        isLoading = true;
        showState('loading');
        
        let url = '/json/?filter=' + currentFilter;
        if (currentCategory) {
            url += '&category=' + currentCategory;
        }
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error('Failed to fetch products');
        }
        
        const products = await response.json();
        
        if (products.length === 0) {
            showState('empty');
        } else {
            renderProducts(products);
            showState('grid');
        }
    } catch (error) {
        console.error('Error:', error);
        showState('error');
    } finally {
        isLoading = false;
    }
}

function changeFilter(filter) {
    currentFilter = filter;
    
    document.getElementById('filter-all').className = filter === 'all'
        ? 'px-4 py-2 rounded-md font-medium transition-colors bg-gray-800 text-white'
        : 'px-4 py-2 rounded-md font-medium transition-colors bg-white text-gray-700 border border-gray-300';
    
    document.getElementById('filter-my').className = filter === 'my_products'
        ? 'px-4 py-2 rounded-md font-medium transition-colors bg-gray-800 text-white'
        : 'px-4 py-2 rounded-md font-medium transition-colors bg-white text-gray-700 border border-gray-300';
    
    fetchProducts();
}

function changeCategory(category) {
    currentCategory = category;
    fetchProducts();
}

function refreshProducts(showToastFlag = true) {
    fetchProducts();
    if(showToastFlag){
        showToast('Refreshed', 'Products list updated', 'success', 5000);
    }
}

function editProduct(productId) {
    fetch(`/json/${productId}/`)
        .then(response => response.json())
        .then(product => {
            document.getElementById('product-id').value = product.id;
            document.getElementById('name').value = product.name;
            document.getElementById('price').value = product.price;
            document.getElementById('description').value = product.description;
            document.getElementById('category').value = product.category;
            document.getElementById('thumbnail').value = product.thumbnail || '';
            document.getElementById('is_featured').checked = product.is_featured;
            document.getElementById('modal-title').textContent = 'Edit Product';
            window.showModal();
        });
}

// Expose refreshProducts to global scope for modal to use
window.refreshProducts = refreshProducts;

// Initial load
window.addEventListener('DOMContentLoaded', function() {
    fetchProducts();
});
</script>

{% endblock content %}